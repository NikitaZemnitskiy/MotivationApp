<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>–ë—É—Å—ë–∏–Ω—ã ‚Äî –¥–ª—è –ª—é–±–∏–º–æ–π</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
<div class="max-w-4xl mx-auto p-4 space-y-6">
  <header class="flex items-center gap-4 mt-4">
    <img id="avatar" src="/assets/avatar.png" alt="avatar" class="w-16 h-16 rounded-full ring-2 ring-pink-400"/>
    <div>
      <h1 class="text-2xl font-bold">–ü—Ä–∏–≤–µ—Ç, <span id="username">–ê–Ω–Ω–∞</span> üíñ</h1>
      <p class="text-sm opacity-80">–¢–≤–æ–π –±–∞–ª–∞–Ω—Å: <span id="balance" class="font-semibold">0</span> –ë—É—Å—ë–∏–Ω–æ–≤</p>
    </div>
    <div class="ml-auto text-right">
      <div class="text-xs opacity-75">–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è —Å <span id="weekStart"></span></div>
      <div class="text-xs opacity-75">–î–æ –∫–æ–Ω—Ü–∞ –Ω–µ–¥–µ–ª–∏: <span id="weekTimer"></span></div>
      <button class="btn" onclick="openHistory()">–ò—Å—Ç–æ—Ä–∏—è</button>
    </div>

  </header>

  <section class="grid md:grid-cols-3 gap-4">
    <div class="md:col-span-2 space-y-4">
      <div class="bg-slate-900/70 p-4 rounded-2xl shadow">
        <h2 class="font-semibold mb-2">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è</h2>
        <div class="space-y-3 text-sm">

          <!-- –ù—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥–∏—è -->
          <div class="p-3 bg-slate-800/60 rounded-xl">
            <div class="flex justify-between items-center">
              <div>
                <div class="font-medium">–ù—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥–∏—è 3 —á–∞—Å–∞/–¥–µ–Ω—å ‚Äî +2</div>
                <div class="opacity-80">–°–µ–≥–æ–¥–Ω—è: <span id="nutriMin">0</span>/180 –º–∏–Ω—É—Ç</div>
              </div>
              <div class="flex gap-2">
                <button id="nutri15" class="btn" onclick="add('nutrition',15)">+15</button>
                <button id="nutri30" class="btn" onclick="add('nutrition',30)">+30</button>
                <button id="nutri60" class="btn" onclick="add('nutrition',60)">+60</button>
              </div>
            </div>
            <div id="nutriBadge" class="text-xs mt-1"></div>
          </div>

          <!-- –ê–Ω–≥–ª–∏–π—Å–∫–∏–π -->
          <div class="p-3 bg-slate-800/60 rounded-xl">
            <div class="flex justify-between items-center">
              <div>
                <div class="font-medium">–ê–Ω–≥–ª–∏–π—Å–∫–∏–π 1 —á–∞—Å ‚Äî +1 (—Å—Ç—Ä–∏–∫ +7/7)</div>
                <div class="opacity-80">–°–µ–≥–æ–¥–Ω—è: <span id="engMin">0</span>/60 –º–∏–Ω—É—Ç</div>
              </div>
              <div class="flex gap-2">
                <button id="eng15" class="btn" onclick="add('english',15)">+15</button>
                <button id="eng30" class="btn" onclick="add('english',30)">+30</button>
                <button id="eng60" class="btn" onclick="add('english',60)">+60</button>
              </div>
            </div>
            <div class="text-xs mt-1 opacity-80">–¢–µ–∫—É—â–∏–π —Å—Ç—Ä–∏–∫: <span id="engStreak">0</span></div>
            <div id="engBadge" class="text-xs mt-1"></div>
          </div>

          <!-- –°–ø–æ—Ä—Ç -->
          <div class="p-3 bg-slate-800/60 rounded-xl flex justify-between">
            <div>
              <div class="font-medium">–°–ø–æ—Ä—Ç ‚Äî +1 (—Å—Ç—Ä–∏–∫ +7/7)</div>
              <div class="text-xs opacity-80">–¢–µ–∫—É—â–∏–π —Å—Ç—Ä–∏–∫: <span id="sportStreak">0</span></div>
            </div>
            <button id="sportBtn" class="btn" onclick="post('/api/tasks/sport/check')">–°–¥–µ–ª–∞–Ω–æ</button>
          </div>

          <!-- –ô–æ–≥–∞ -->
          <div class="p-3 bg-slate-800/60 rounded-xl flex justify-between">
            <div><div class="font-medium">–ô–æ–≥–∞ ‚Äî +1</div></div>
            <button id="yogaBtn" class="btn" onclick="post('/api/tasks/yoga/check')">–°–¥–µ–ª–∞–Ω–æ</button>
          </div>

          <!-- –í—å–µ—Ç–Ω–∞–º—Å–∫–∏–µ —Å–ª–æ–≤–∞ -->
          <div class="p-3 bg-slate-800/60 rounded-xl flex justify-between">
            <div>
              <div class="font-medium">1 –≤—å–µ—Ç–Ω–∞–º—Å–∫–æ–µ —Å–ª–æ–≤–æ !–° –ø—Ä–∏–º–∏–Ω–µ–Ω–∏–µ–º! ‚Äî +1 (—Å—Ç—Ä–∏–∫ +7/7)</div>
              <div class="text-xs opacity-80">–¢–µ–∫—É—â–∏–π —Å—Ç—Ä–∏–∫: <span id="vietStreak">0</span></div>
            </div>
            <button id="vietBtn" class="btn" onclick="post('/api/tasks/vietnamese/check')">–°–¥–µ–ª–∞–Ω–æ</button>
          </div>

          <div id="genericDaily" class="space-y-2"></div>
        </div>
      </div>

      <div class="bg-slate-900/70 p-4 rounded-2xl shadow">
        <h2 class="font-semibold mb-2">–û–±—â–∏–µ —Ä–∞–∑–æ–≤—ã–µ —Ü–µ–ª–∏</h2>
        <div id="goals" class="grid sm:grid-cols-2 gap-2"></div>
      </div>
    </div>

    <div class="space-y-4">
      <div class="bg-slate-900/70 p-4 rounded-2xl shadow">
        <h2 class="font-semibold mb-2">–ù–µ–¥–µ–ª—å–Ω–æ–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ</h2>
        <div class="text-sm opacity-90">–ù—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥–∏—è 18 —á–∞—Å–æ–≤/–Ω–µ–¥–µ–ª—é</div>
        <div class="w-full bg-slate-800 rounded-full h-3 my-2">
          <div id="weekBar" class="bg-pink-500 h-3 rounded-full" style="width:0%"></div>
        </div>
        <div class="text-xs opacity-80">–°–æ–±—Ä–∞–Ω–æ: <span id="weekMin">0</span>/1080 –º–∏–Ω—É—Ç</div>
        <p class="text-xs mt-2 opacity-60">
          –ü–æ –∏—Ç–æ–≥–∞–º –Ω–µ–¥–µ–ª–∏: &ge;1080 –º–∏–Ω ‚Üí +14, –∏–Ω–∞—á–µ ‚àí20. –®—Ç—Ä–∞—Ñ/–Ω–∞–≥—Ä–∞–¥–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–µ–¥–µ–ª–∏.
        </p>
      </div>

      <div class="bg-slate-900/70 p-4 rounded-2xl shadow">
        <h2 class="font-semibold mb-2">–ú–∞–≥–∞–∑–∏–Ω</h2>
        <div id="shop" class="space-y-2"></div>
      </div>
    </div>
  </section>

  <footer class="text-center text-xs opacity-60 py-6">–°–¥–µ–ª–∞–Ω–æ —Å –ª—é–±–æ–≤—å—é üíò</footer>
</div>

<style>
  .cal-cell {
    border-radius: .75rem; padding:.5rem; min-height:64px;
    background: rgba(2,6,23,0.6); border:1px solid rgba(148,163,184,0.2);
    cursor: pointer; transition: transform .15s ease;
  }
  .cal-cell:hover { transform: translateY(-1px); }
  .cal-cell .date { font-size:.75rem; opacity:.8; }
  .cal-cell .sum { font-size:.85rem; font-weight:600; }
  .cal-red    { background: rgba(239,68,68,.15);  border-color: rgba(239,68,68,.4); }
  .cal-yellow { background: rgba(234,179,8,.15);  border-color: rgba(234,179,8,.4); }
  .cal-green  { background: rgba(16,185,129,.15); border-color: rgba(16,185,129,.4); }
  .btn {
    padding: .5rem .75rem;
    background: rgba(236,72,153,0.2);
    border: 1px solid rgba(236,72,153,0.5);
    border-radius: .75rem;
    transition: all .25s ease;
  }
  .btn:hover { transform: translateY(-1px); }

  .btn.done {
    background: linear-gradient(90deg, rgba(34,197,94,0.25), rgba(34,197,94,0.15));
    border-color: rgba(34,197,94,0.6);
  }

  .btn[disabled]{
    opacity: .6;
    filter: grayscale(0.4);
    cursor: not-allowed;
    transform: none;
  }

  .pill { padding:.15rem .5rem; border-radius:999px; font-size:.7rem; }
</style>

<script>
  const $ = sel => document.querySelector(sel);

  async function api(url, opts={}){
    opts.headers = opts.headers || {};
    const r = await fetch(url, opts);
    if (r.status === 401){
      window.location.href = '/login.html?redirect=' + encodeURIComponent(location.pathname);
      return;
    }
    if (!r.ok){
      const t = await r.text();
      throw new Error(t || ('HTTP '+r.status));
    }
    return r.json();
  }

  function formatTimer(sec){
    const now = Math.floor(Date.now()/1000);
    let left = Math.max(0, sec - now);
    const d = Math.floor(left/86400);
    left -= d*86400;
    const h = Math.floor(left/3600);
    left -= h*3600;
    const m = Math.floor(left/60);
    const s = left - m*60;
    return `${d}–¥ ${h}—á ${m}–º ${s}—Å`;
  }

  function toggleBtn(id, isDone){
    const el = document.getElementById(id);
    if (!el) return;
    el.disabled = !!isDone;
    el.classList.toggle('done', !!isDone);
  }

  function flash(el){
    if (!el) return;
    el.style.boxShadow = '0 0 0 9999px rgba(34,197,94,0.08) inset';
    setTimeout(() => el.style.boxShadow = '', 180);
  }

  async function load(){
    const data = await api('/api/me');
    if (!data) return; // –µ—Å–ª–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /login —É–∂–µ —Å–¥–µ–ª–∞–Ω

    $('#username').textContent = data.username;
    $('#avatar').src = data.avatarUrl || '/assets/avatar.png';
    $('#balance').textContent = data.balance;
    $('#nutriMin').textContent = data.todayNutritionMinutes;
    $('#engMin').textContent = data.todayEnglishMinutes;
    $('#engStreak').textContent = data.englishStreak;
    $('#sportStreak').textContent = data.sportStreak;
    $('#vietStreak').textContent = data.vietStreak;
    $('#weekMin').textContent = data.weekNutritionMinutes;
    $('#weekStart').textContent = data.currentWeekStart;

    const pct = Math.min(100, Math.round(100*data.weekNutritionMinutes / data.weekGoalMinutes));
    $('#weekBar').style.width = pct + '%';

    $('#nutriBadge').innerHTML = data.todayNutritionAwarded
            ? '<span class="pill bg-emerald-600/40">–°–µ–≥–æ–¥–Ω—è –≤—ã–ø–æ–ª–Ω–µ–Ω–æ ‚úî</span>'
            : '<span class="pill bg-slate-700/70">–ù—É–∂–Ω–æ –¥–æ–±—Ä–∞—Ç—å –¥–æ 180 –º–∏–Ω—É—Ç</span>';
    $('#engBadge').innerHTML = data.todayEnglishAwarded
            ? '<span class="pill bg-emerald-600/40">–°–µ–≥–æ–¥–Ω—è –≤—ã–ø–æ–ª–Ω–µ–Ω–æ ‚úî</span>'
            : '<span class="pill bg-slate-700/70">–ù—É–∂–Ω–æ –¥–æ–±—Ä–∞—Ç—å –¥–æ 60 –º–∏–Ω—É—Ç</span>';

    toggleBtn('sportBtn', !!data.todaySportDone);
    toggleBtn('yogaBtn',  !!data.todayYogaDone);
    toggleBtn('vietBtn',  !!data.todayVietDone);

    const g = $('#goals'); g.innerHTML='';
    data.goals.forEach(goal => {
      const done = !!goal.completedAt;
      const btn = done ? `<button class="btn done" disabled>–ì–æ—Ç–æ–≤–æ</button>`
              : `<button class="btn" onclick="post('/api/goals/${goal.id}/complete')">–ó–∞—Å—á–∏—Ç–∞—Ç—å (+${goal.reward})</button>`;
      g.insertAdjacentHTML('beforeend', `
          <div class="p-3 bg-slate-800/60 rounded-xl flex items-center justify-between">
            <div>${goal.title} ‚Äî <span class="opacity-80">+${goal.reward}</span></div>
            ${btn}
          </div>
        `);
    });

    const shop = $('#shop'); shop.innerHTML='';
    data.shop.forEach(item => {
      const afford = data.balance >= item.cost;
      shop.insertAdjacentHTML('beforeend', `
          <div class="p-3 bg-slate-800/60 rounded-xl flex items-center justify-between">
            <div>${item.title}</div>
            <div class="flex items-center gap-2">
              <div class="text-xs opacity-80">${item.cost}</div>
              <button class="btn" ${afford?'':'disabled'} onclick="post('/api/shop/${item.id}/purchase')">–ö—É–ø–∏—Ç—å</button>
            </div>
          </div>
        `);
    });

    const gd = $('#genericDaily'); gd.innerHTML = '';
    (data.genericDaily || []).forEach(def => {
      const done = data.todayGenericDone && data.todayGenericDone[def.id];
      const streak = (data.genericStreaks && data.genericStreaks[def.id]) || 0;
      gd.insertAdjacentHTML('beforeend', `
          <div class="p-3 bg-slate-800/60 rounded-xl flex items-center justify-between">
            <div>
              <div class="font-medium">${def.title} ‚Äî +${def.dailyReward}${def.streakEnabled?' (—Å—Ç—Ä–∏–∫ +7/7)':''}</div>
              ${def.streakEnabled?`<div class="text-xs opacity-80">–°—Ç—Ä–∏–∫: ${streak}</div>`:''}
            </div>
            <button class="btn ${done?'done':''}" ${done?'disabled':''}
                    onclick="post('/api/tasks/generic/${def.id}/check')">${done?'–ì–æ—Ç–æ–≤–æ':'–°–¥–µ–ª–∞–Ω–æ'}</button>
          </div>
        `);
    });

    function tick(){
      $('#weekTimer').textContent = formatTimer(data.secondsUntilWeekEndEpoch);
    }
    clearInterval(window.__t);
    tick();
    window.__t = setInterval(tick, 1000);
  }

  async function post(url){
    await api(url, {method:'POST'});
    if (url.includes('/sport/'))      flash(document.getElementById('sportBtn'));
    if (url.includes('/yoga/'))       flash(document.getElementById('yogaBtn'));
    if (url.includes('/vietnamese/')) flash(document.getElementById('vietBtn'));
    await load();
  }

  async function add(kind, m){
    await api(`/api/tasks/${kind}/add?minutes=${m}`, {method:'POST'});
    if (kind === 'nutrition') flash(document.getElementById('nutri30'));
    if (kind === 'english')   flash(document.getElementById('eng30'));
    await load();
  }
  // === –ò—Å—Ç–æ—Ä–∏—è / –∫–∞–ª–µ–Ω–¥–∞—Ä—å ===
  let histYear, histMonth; // 1..12
  function openHistory(){
    const now = new Date();
    histYear = now.getFullYear();
    histMonth = now.getMonth()+1;
    $('#histModal').classList.remove('hidden');
    $('#histModal').classList.add('flex');
    renderHistory();
  }
  function closeHistory(){
    $('#histModal').classList.add('hidden');
    $('#histModal').classList.remove('flex');
  }
  function shiftMonth(delta){
    histMonth += delta;
    if (histMonth <= 0){ histMonth = 12; histYear--; }
    if (histMonth >= 13){ histMonth = 1; histYear++; }
    renderHistory();
  }
  function monthLabel(y, m){
    const d = new Date(Date.UTC(y, m-1, 1));
    return d.toLocaleString('ru-RU', {month:'long', year:'numeric'});
  }

  async function renderHistory(){
    $('#histMonthLabel').textContent = monthLabel(histYear, histMonth);
    const data = await api(`/api/history/month?year=${histYear}&month=${histMonth}`);
    if (!data) return;

    // —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è –Ω–∞—á–∞–ª–∞ –º–µ—Å—è—Ü–∞ (—Å –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞)
    const first = new Date(histYear, histMonth-1, 1);
    let offset = (first.getDay() + 6) % 7; // 0=Mon .. 6=Sun
    const grid = $('#histGrid'); grid.innerHTML = '';

    for (let i=0;i<offset;i++){
      grid.insertAdjacentHTML('beforeend', `<div></div>`);
    }

    data.days.forEach(d => {
      const dt = new Date(d.date);
      const day = dt.getDate();
      const total = d.total || 0;

      let cls = 'cal-cell';
      if (total < 3) cls += ' cal-red';
      else if (total <= 5) cls += ' cal-yellow';
      else cls += ' cal-green';

      grid.insertAdjacentHTML('beforeend', `
        <div class="${cls}" onclick="openDay('${d.date}')">
          <div class="date">${String(day).padStart(2,'0')}</div>
          <div class="sum">${total} –±–∞–ª.</div>
        </div>
      `);
    });

    // –æ—á–∏—Å—Ç–∏—Ç—å –ø–∞–Ω–µ–ª—å –¥–Ω—è
    $('#histDayPanel').classList.add('hidden');
    $('#histDayList').innerHTML = '';
  }

  async function openDay(dateStr){
    const d = await api(`/api/history/day?date=${dateStr}`);
    if (!d) return;
    $('#histDayLabel').textContent = new Date(d.date).toLocaleDateString('ru-RU', {day:'2-digit', month:'long', year:'numeric'});
    const wrap = $('#histDayList'); wrap.innerHTML = '';
    if (!d.items || d.items.length === 0){
      wrap.innerHTML = `<div class="text-sm opacity-70">–ù–∏—á–µ–≥–æ –Ω–µ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å.</div>`;
    } else {
      d.items.forEach(it => {
        wrap.insertAdjacentHTML('beforeend', `
          <div class="p-2 rounded-lg bg-slate-800/60 border border-slate-700/50 flex justify-between">
            <div class="text-sm">${it.label}</div>
            <div class="text-sm font-semibold">+${it.points}</div>
          </div>
        `);
      });
      wrap.insertAdjacentHTML('beforeend', `
        <div class="mt-2 p-2 rounded-lg bg-slate-900/60 border border-slate-700/50 flex justify-between">
          <div class="text-sm font-semibold">–ò—Ç–æ–≥–æ</div>
          <div class="text-sm font-semibold">+${d.total}</div>
        </div>
      `);
    }
    $('#histDayPanel').classList.remove('hidden');
  }

  load();
</script>
<!-- –ò—Å—Ç–æ—Ä–∏—è: –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div id="histModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
  <div class="bg-slate-900 w-full max-w-3xl rounded-2xl shadow-xl p-4">
    <div class="flex items-center justify-between mb-3">
      <div class="flex items-center gap-2">
        <button class="btn" onclick="shiftMonth(-1)">‚Äπ</button>
        <div class="text-lg font-semibold"><span id="histMonthLabel"></span></div>
        <button class="btn" onclick="shiftMonth(1)">‚Ä∫</button>
      </div>
      <div class="flex items-center gap-2">
        <span class="pill bg-red-500/30"> <3 –±–∞–ª–ª–æ–≤ </span>
        <span class="pill bg-yellow-500/30"> 3‚Äì5 –±–∞–ª–ª–æ–≤ </span>
        <span class="pill bg-emerald-500/30"> >5 –±–∞–ª–ª–æ–≤ </span>
        <button class="btn" onclick="closeHistory()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>

    <div class="grid grid-cols-7 text-xs opacity-70 mb-2">
      <div>–ü–Ω</div><div>–í—Ç</div><div>–°—Ä</div><div>–ß—Ç</div><div>–ü—Ç</div><div>–°–±</div><div>–í—Å</div>
    </div>
    <div id="histGrid" class="grid grid-cols-7 gap-2"></div>

    <div id="histDayPanel" class="mt-4 hidden">
      <div class="text-sm font-semibold mb-2">–î–µ—Ç–∞–ª–∏: <span id="histDayLabel"></span></div>
      <div id="histDayList" class="space-y-1"></div>
    </div>
  </div>
</div>

</body>
</html>
