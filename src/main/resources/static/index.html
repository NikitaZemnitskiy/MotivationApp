<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>–ë—É—Å—ë–∏–Ω—ã ‚Äî –¥–ª—è –ª—é–±–∏–º–æ–π</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
<div class="max-w-4xl mx-auto p-4 space-y-6">
  <header class="flex items-center gap-4 mt-4">
    <img id="avatar" src="/assets/avatar.png" alt="avatar" class="w-16 h-16 rounded-full ring-2 ring-pink-400"/>
    <div>
      <h1 class="text-2xl font-bold">–ü—Ä–∏–≤–µ—Ç, <span id="username">–ê–Ω–Ω–∞</span> üíñ</h1>
      <p class="text-sm opacity-80">–¢–≤–æ–π –±–∞–ª–∞–Ω—Å: <span id="balance" class="font-semibold  text-4xl">0</span> –ë—É—Å—ë–∏–Ω–æ–≤</p>
    </div>
    <div class="ml-auto text-right">
      <div class="text-xs opacity-75">–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è —Å <span id="weekStart"></span></div>
      <div class="text-xs opacity-75">–î–æ –∫–æ–Ω—Ü–∞ –Ω–µ–¥–µ–ª–∏: <span id="weekTimer"></span></div>
      <button class="btn" onclick="window.location.href='wheel.html'">–†—É–ª–µ—Ç–∫–∞ üé°</button>
      <button class="btn" onclick="openHistory()">–ò—Å—Ç–æ—Ä–∏—è</button>
      <button class="btn" onclick="openPurchases()">–ü–æ–∫—É–ø–∫–∏</button>
      <button id="giftBtn" class="btn" onclick="openGifts()">üéÅ</button>
    </div>

  </header>

  <section class="grid md:grid-cols-3 gap-4">
    <div class="md:col-span-2 space-y-4">
      <div class="bg-slate-900/70 p-4 rounded-2xl shadow">
        <h2 class="font-semibold mb-2">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è</h2>
        <div id="tasks" class="space-y-3 text-sm"></div>
      </div>

      <div class="bg-slate-900/70 p-4 rounded-2xl shadow">
        <h2 class="font-semibold mb-2">–û–±—â–∏–µ —Ä–∞–∑–æ–≤—ã–µ —Ü–µ–ª–∏</h2>
        <div id="goals" class="grid sm:grid-cols-2 gap-2"></div>
      </div>
    </div>

    <div class="space-y-4">
      <div class="bg-slate-900/70 p-4 rounded-2xl shadow">
        <h2 class="font-semibold mb-2">–ù–µ–¥–µ–ª—å–Ω–æ–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ</h2>
        <div class="text-sm opacity-90" id="weekGoalTitle"></div>
        <div class="w-full bg-slate-800 rounded-full h-3 my-2">
          <div id="weekBar" class="bg-pink-500 h-3 rounded-full" style="width:0%"></div>
        </div>
        <div class="text-xs opacity-80">–°–æ–±—Ä–∞–Ω–æ: <span id="weekMin">0</span>/<span id="weekGoal">0</span> –º–∏–Ω—É—Ç</div>
        <p class="text-xs mt-2 opacity-60">
          –ü–æ –∏—Ç–æ–≥–∞–º –Ω–µ–¥–µ–ª–∏: &ge;900 –º–∏–Ω ‚Üí +14, –∏–Ω–∞—á–µ ‚àí20. –®—Ç—Ä–∞—Ñ/–Ω–∞–≥—Ä–∞–¥–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–µ–¥–µ–ª–∏.
        </p>
        <div id="weekDailyList" class="mt-3 space-y-1 text-sm"></div>
      </div>

      <div class="bg-slate-900/70 p-4 rounded-2xl shadow">
        <h2 class="font-semibold mb-2">–ú–∞–≥–∞–∑–∏–Ω</h2>
        <div id="shop" class="space-y-2"></div>
      </div>
    </div>
  </section>

  <footer class="text-center text-xs opacity-60 py-6">–°–¥–µ–ª–∞–Ω–æ —Å –ª—é–±–æ–≤—å—é üíò</footer>
</div>

<style>
  .cal-cell {
    border-radius: .75rem; padding:.5rem; min-height:64px;
    background: rgba(2,6,23,0.6); border:1px solid rgba(148,163,184,0.2);
    cursor: pointer; transition: transform .15s ease;
  }
  .cal-cell:hover { transform: translateY(-1px); }
  .cal-cell .date { font-size:.75rem; opacity:.8; }
  .cal-cell .sum { font-size:.85rem; font-weight:600; }
  .cal-red    { background: rgba(239,68,68,.15);  border-color: rgba(239,68,68,.4); }
  .cal-yellow { background: rgba(234,179,8,.15);  border-color: rgba(234,179,8,.4); }
  .cal-green  { background: rgba(16,185,129,.15); border-color: rgba(16,185,129,.4); }
  .btn {
    padding: .5rem .75rem;
    background: rgba(236,72,153,0.2);
    border: 1px solid rgba(236,72,153,0.5);
    border-radius: .75rem;
    transition: all .25s ease;
  }
  .btn:hover { transform: translateY(-1px); }

  .btn.done {
    background: linear-gradient(90deg, rgba(34,197,94,0.25), rgba(34,197,94,0.15));
    border-color: rgba(34,197,94,0.6);
  }

  .btn[disabled]{
    opacity: .6;
    filter: grayscale(0.4);
    cursor: not-allowed;
    transform: none;
  }

  .pill { padding:.15rem .5rem; border-radius:999px; font-size:.7rem; }
</style>

<script>
  const $ = sel => document.querySelector(sel);

  async function api(url, opts={}){
    opts.headers = opts.headers || {};
    const r = await fetch(url, opts);
    if (r.status === 401){
      window.location.href = '/login.html?redirect=' + encodeURIComponent(location.pathname);
      return;
    }
    if (!r.ok){
      const t = await r.text();
      throw new Error(t || ('HTTP '+r.status));
    }
    return r.json();
  }

  function formatTimer(sec){
    const now = Math.floor(Date.now()/1000);
    let left = Math.max(0, sec - now);
    const d = Math.floor(left/86400);
    left -= d*86400;
    const h = Math.floor(left/3600);
    left -= h*3600;
    const m = Math.floor(left/60);
    const s = left - m*60;
    return `${d}–¥ ${h}—á ${m}–º ${s}—Å`;
  }

  function toggleBtn(id, isDone){
    const el = document.getElementById(id);
    if (!el) return;
    el.disabled = !!isDone;
    el.classList.toggle('done', !!isDone);
  }

  function flash(el){
    if (!el) return;
    el.style.boxShadow = '0 0 0 9999px rgba(34,197,94,0.08) inset';
    setTimeout(() => el.style.boxShadow = '', 180);
  }

  function applyDailyX2(id, base){
    const el = document.getElementById('dailyReward-' + id);
    if (!el) return;
    el.innerHTML = `<span class="line-through opacity-60">+${base}</span> <span class="text-pink-400 text-lg font-bold">+${base*2}</span>`;
  }

  async function load(){
    const [data, roulette] = await Promise.all([
      api('/api/me'),
      api('/api/roulette/today')
    ]);
    if (!data || !roulette) return;

    $('#username').textContent = data.username;
    $('#avatar').src = data.avatarUrl || '/assets/avatar.png';
    $('#balance').textContent = data.balance;
    $('#weekMin').textContent = data.weekMinutes;
    $('#weekStart').textContent = data.currentWeekStart;

    const gifts = data.gifts || [];
    const gbtn = document.getElementById('giftBtn');
    if (gbtn){
      if (gifts.length > 0){
        gbtn.style.background = 'rgba(251,191,36,0.3)';
        gbtn.style.borderColor = 'rgba(251,191,36,0.6)';
      } else {
        gbtn.style.background = '';
        gbtn.style.borderColor = '';
      }
    }

    const pct = Math.min(100, data.weekGoalMinutes ? Math.round(100*data.weekMinutes / data.weekGoalMinutes) : 0);
    $('#weekBar').style.width = pct + '%';
    $('#weekGoal').textContent = data.weekGoalMinutes || 0;
    const wl = $('#weekDailyList'); wl.innerHTML='';
    (data.weekDaily || []).forEach(t => {
      const left = t.required - t.done;
      const done = left <= 0;
      const status = done ? '–ì–æ—Ç–æ–≤–æ' : `–û—Å—Ç–∞–ª–æ—Å—å: ${left}`;
      wl.insertAdjacentHTML('beforeend', `
        <div class="flex justify-between ${done?'opacity-60':''}">
          <div>${t.title}</div>
          <div>${status}${done?' ‚úî':''}</div>
        </div>
      `);
    });

    // Render unified tasks (MINUTES first)
    const tasksWrap = document.getElementById('tasks'); tasksWrap.innerHTML='';
    const allTasks = (data.tasks || []);
    const orderedTasks = allTasks.filter(t => t.kind === 'MINUTES')
      .concat(allTasks.filter(t => t.kind !== 'MINUTES'));
    orderedTasks.forEach(t => {
      let rewardHtml = `+${t.dailyReward}`;
      if (roulette.effect === 'DAILY_X2' && roulette.dailyId === t.id){
        rewardHtml = `<span class="line-through opacity-60">+${t.dailyReward}</span> <span class="text-pink-400 text-lg font-bold">+${t.dailyReward*2}</span>`;
      }
      if (t.kind === 'MINUTES'){
        const cur = t.todayMinutes||0;
        const need = t.minutesPerDay||0;
        const done = !!t.todayDone;
        tasksWrap.insertAdjacentHTML('beforeend', `
          <div class="p-3 bg-slate-800/60 rounded-xl">
            <div class="flex justify-between items-center">
              <div>
                <div class="font-medium">${t.title} ‚Äî <span class="reward">${rewardHtml}</span>${t.streakEnabled?` (—Å—Ç—Ä–∏–∫ +7/7)`:''}</div>
                ${need?`<div class="opacity-80">–°–µ–≥–æ–¥–Ω—è: <span>${cur}</span>/${need} –º–∏–Ω—É—Ç</div>`:''}
              </div>
              <div class="flex gap-2">
                <button class="btn" onclick="addGeneric('${t.id}',15)">+15</button>
                <button class="btn" onclick="addGeneric('${t.id}',30)">+30</button>
                <button class="btn" onclick="addGeneric('${t.id}',60)">+60</button>
              </div>
            </div>
            <div class="text-xs mt-1">${done?'<span class="pill bg-emerald-600/40">–°–µ–≥–æ–¥–Ω—è –≤—ã–ø–æ–ª–Ω–µ–Ω–æ ‚úî</span>':''}</div>
          </div>`);
      } else {
        const done = !!t.todayDone;
        tasksWrap.insertAdjacentHTML('beforeend', `
          <div class="p-3 bg-slate-800/60 rounded-xl flex justify-between">
            <div>
              <div class="font-medium">${t.title} ‚Äî <span class="reward">${rewardHtml}</span>${t.streakEnabled?` (—Å—Ç—Ä–∏–∫ +7/7)`:''}</div>
              ${t.streakEnabled?`<div class="text-xs opacity-80">–°—Ç—Ä–∏–∫: ${t.streak||0}</div>`:''}
            </div>
            <button class="btn ${done?'done':''}" ${done?'disabled':''} onclick="post('/api/tasks/${t.id}/check')">${done?'–ì–æ—Ç–æ–≤–æ':'–°–¥–µ–ª–∞–Ω–æ'}</button>
          </div>`);
      }
    });

    const g = $('#goals'); g.innerHTML='';
    data.goals.forEach(goal => {
      const done = !!goal.completedAt;
      let rewardHtml = `+${goal.reward}`;
      let rewardClass = 'opacity-80';
      if (roulette.effect === 'GOAL_X2' && roulette.goalId === goal.id){
        rewardHtml = `<span class="line-through opacity-60">+${goal.reward}</span> <span class="text-pink-400 text-lg font-bold">+${goal.reward*2}</span>`;
        rewardClass = '';
      }
      const btn = done ? `<button class="btn done" disabled>–ì–æ—Ç–æ–≤–æ</button>`
              : `<button class="btn" onclick="post('/api/goals/${goal.id}/complete')">–ó–∞—Å—á–∏—Ç–∞—Ç—å (${rewardHtml})</button>`;
      g.insertAdjacentHTML('beforeend', `
            <div class="p-3 bg-slate-800/60 rounded-xl flex items-center justify-between">
              <div>${goal.title} ‚Äî <span class="${rewardClass}">${rewardHtml}</span></div>
              ${btn}
            </div>
          `);
    });

    const shop = $('#shop'); shop.innerHTML='';
    data.shop.forEach(item => {
      const eff = (item.effectiveCost ?? item.cost);
      const afford = data.balance >= eff;
      shop.insertAdjacentHTML('beforeend', `
            <div class="p-3 bg-slate-800/60 rounded-xl flex items-center justify-between">
              <div>${item.title}</div>
              <div class="flex items-center gap-2">
                <div class="text-xs opacity-80">${eff !== item.cost ? `<span class='line-through opacity-60 mr-1'>${item.cost}</span> <span class='text-pink-400 font-semibold'>${eff}</span>` : `${item.cost}`}</div>
                <button class="btn" ${afford?'':'disabled'} onclick="post('/api/shop/${item.id}/purchase')">–ö—É–ø–∏—Ç—å</button>
              </div>
            </div>
          `);
    });

    const gd = $('#genericDaily'); gd.innerHTML = '';
    (data.genericDaily || []).forEach(def => {
      const done = data.todayGenericDone && data.todayGenericDone[def.id];
      const streak = (data.genericStreaks && data.genericStreaks[def.id]) || 0;
      let rewardHtml = `+${def.dailyReward}`;
      if (roulette.effect === 'DAILY_X2' && roulette.dailyId === 'g:' + def.id){
        rewardHtml = `<span class="line-through opacity-60">+${def.dailyReward}</span> <span class="text-pink-400 text-lg font-bold">+${def.dailyReward*2}</span>`;
      }
      gd.insertAdjacentHTML('beforeend', `
            <div class="p-3 bg-slate-800/60 rounded-xl flex items-center justify-between">
              <div>
                <div class="font-medium">${def.title} ‚Äî ${rewardHtml}${def.streakEnabled?' (—Å—Ç—Ä–∏–∫ +7/7)':''}</div>
                ${def.streakEnabled?`<div class="text-xs opacity-80">–°—Ç—Ä–∏–∫: ${streak}</div>`:''}
              </div>
              <button class="btn ${done?'done':''}" ${done?'disabled':''}
                      onclick="post('/api/tasks/generic/${def.id}/check')">${done?'–ì–æ—Ç–æ–≤–æ':'–°–¥–µ–ª–∞–Ω–æ'}</button>
            </div>
          `);
    });

    if (roulette.effect === 'DAILY_X2'){
      const id = roulette.dailyId;
      if (id && !id.startsWith('g:')){
        applyDailyX2(id, roulette.dailyBaseReward);
      }
    }

    function tick(){
      $('#weekTimer').textContent = formatTimer(data.secondsUntilWeekEndEpoch);
    }
    clearInterval(window.__t);
    tick();
    window.__t = setInterval(tick, 1000);
  }

  async function post(url){
    await api(url, {method:'POST'});
    // unified buttons are generic now
    await load();
  }

  async function addGeneric(id, m){
    await api(`/api/tasks/${id}/add?minutes=${m}`, {method:'POST'});
    await load();
  }
  // === –ò—Å—Ç–æ—Ä–∏—è / –∫–∞–ª–µ–Ω–¥–∞—Ä—å ===
  let histYear, histMonth; // 1..12
  async function openHistory(){
    // use server-side today (timezone-aware) from roulette API
    try {
      const r = await api('/api/roulette/today');
      const d = r && r.date ? new Date(r.date) : new Date();
      histYear = d.getFullYear();
      histMonth = d.getMonth()+1;
    } catch(e){
      const now = new Date();
      histYear = now.getFullYear();
      histMonth = now.getMonth()+1;
    }
    $('#histModal').classList.remove('hidden');
    $('#histModal').classList.add('flex');
    renderHistory();
  }
  function closeHistory(){
    $('#histModal').classList.add('hidden');
    $('#histModal').classList.remove('flex');
  }
  function shiftMonth(delta){
    histMonth += delta;
    if (histMonth <= 0){ histMonth = 12; histYear--; }
    if (histMonth >= 13){ histMonth = 1; histYear++; }
    renderHistory();
  }
  function monthLabel(y, m){
    const d = new Date(Date.UTC(y, m-1, 1));
    return d.toLocaleString('ru-RU', {month:'long', year:'numeric'});
  }

  async function renderHistory(){
    $('#histMonthLabel').textContent = monthLabel(histYear, histMonth);
    const data = await api(`/api/history/month?year=${histYear}&month=${histMonth}`);
    if (!data) return;

    // —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è –Ω–∞—á–∞–ª–∞ –º–µ—Å—è—Ü–∞ (—Å –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞)
    const first = new Date(histYear, histMonth-1, 1);
    let offset = (first.getDay() + 6) % 7; // 0=Mon .. 6=Sun
    const grid = $('#histGrid'); grid.innerHTML = '';

    for (let i=0;i<offset;i++){
      grid.insertAdjacentHTML('beforeend', `<div></div>`);
    }

    data.days.forEach(d => {
      const dt = new Date(d.date);
      const day = dt.getDate();
      total = d.total?d.total:0
      let cls = 'cal-cell';
      if (total < 3) cls += ' cal-red';
      else if (total <= 5) cls += ' cal-yellow';
      else cls += ' cal-green';

      grid.insertAdjacentHTML('beforeend', `
        <div class="${cls}" onclick="openDay('${d.date}')">
          <div class="date">${String(day).padStart(2,'0')}</div>
          <div class="sum">${total} –±–∞–ª.</div>
        </div>
      `);
    });

    // –æ—á–∏—Å—Ç–∏—Ç—å –ø–∞–Ω–µ–ª—å –¥–Ω—è
    $('#histDayPanel').classList.add('hidden');
    $('#histDayList').innerHTML = '';
  }

  async function openDay(dateStr){
    const d = await api(`/api/history/day?date=${dateStr}`);
    if (!d) return;
    $('#histDayLabel').textContent = new Date(d.date).toLocaleDateString('ru-RU', {day:'2-digit', month:'long', year:'numeric'});
    const wrap = $('#histDayList'); wrap.innerHTML = '';
    if (!d.items || d.items.length === 0){
      wrap.innerHTML = `<div class="text-sm opacity-70">–ù–∏—á–µ–≥–æ –Ω–µ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å.</div>`;
    } else {
      d.items.forEach(it => {
        const sign = it.points > 0 ? '+' : '';
        wrap.insertAdjacentHTML('beforeend', `
          <div class="p-2 rounded-lg bg-slate-800/60 border border-slate-700/50 flex justify-between">
            <div class="text-sm">${it.label}</div>
            <div class="text-sm font-semibold">${sign}${it.points}</div>
          </div>
        `);
      });
      wrap.insertAdjacentHTML('beforeend', `
        <div class="mt-2 p-2 rounded-lg bg-slate-900/60 border border-slate-700/50 flex justify-between">
          <div class="text-sm font-semibold">–ò—Ç–æ–≥–æ</div>
          <div class="text-sm font-semibold">${d.total >= 0 ? '+' : ''}${d.total}</div>
        </div>
      `);
    }
    $('#histDayPanel').classList.remove('hidden');
  }

  async function openPurchases(){
    const data = await api('/api/purchases');
    const wrap = $('#purchList'); wrap.innerHTML = '';
    if (!data || data.length === 0){
      wrap.innerHTML = `<div class="text-sm opacity-70">–ü–æ–∫—É–ø–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç.</div>`;
    } else {
      data.forEach(p => {
        const dt = new Date(p.purchasedAt).toLocaleDateString('ru-RU', {day:'2-digit', month:'long', year:'numeric'});
        wrap.insertAdjacentHTML('beforeend', `
          <div class="p-2 rounded-lg bg-slate-800/60 border border-slate-700/50 flex justify-between">
            <div class="text-sm">${p.titleSnapshot} <span class="opacity-60 text-xs">${dt}</span></div>
            <div class="text-sm font-semibold">-${p.costSnapshot}</div>
          </div>
        `);
      });
    }
    $('#purchModal').classList.remove('hidden');
    $('#purchModal').classList.add('flex');
  }
  function closePurchases(){
    $('#purchModal').classList.add('hidden');
    $('#purchModal').classList.remove('flex');
  }

  async function openGifts(){
    const data = await api('/api/me');
    const wrap = $('#giftsList'); wrap.innerHTML='';
    const gifts = (data && data.gifts) || [];
    if (gifts.length === 0){
      wrap.innerHTML = `<div class="text-sm opacity-70">–ü–æ–¥–∞—Ä–∫–æ–≤ –Ω–µ—Ç.</div>`;
    } else {
      gifts.forEach(g => {
        wrap.insertAdjacentHTML('beforeend', `
          <div class="p-2 rounded-lg bg-slate-800/60 border border-slate-700/50 flex justify-between items-center">
            <div class="text-sm">${g.title} <span class="opacity-60 text-xs">+${g.amount}</span></div>
            <button class="btn" onclick="acceptGift('${g.id}')">–ü—Ä–∏–Ω—è—Ç—å</button>
          </div>
        `);
      });
    }
    $('#giftsModal').classList.remove('hidden');
    $('#giftsModal').classList.add('flex');
  }
  function closeGifts(){
    $('#giftsModal').classList.add('hidden');
    $('#giftsModal').classList.remove('flex');
  }
  async function acceptGift(id){
    await api('/api/gifts/' + id + '/accept', {method:'POST'});
    await load();
    await openGifts();
  }

  function openWheel(){
    const m = document.getElementById('wheelModal');
    m.classList.remove('hidden');
    m.classList.add('flex');
    loadWheel();
  }
  function closeWheel(){
    const m = document.getElementById('wheelModal');
    m.classList.add('hidden');
    m.classList.remove('flex');
    updateNextSpin(null);
  }
  async function loadWheel(){
    const j = await api('/api/roulette/today');
    if (!j) return;
    document.getElementById('wheelMsg').textContent = j.message || '';
    document.getElementById('spinBtn').disabled = !j.canSpin;
    updateNextSpin(j.canSpin ? null : j.nextSpinAt);
  }
  async function spinWheel(){
    const wheel = document.getElementById('wheel');
    wheel.classList.remove('spin'); void wheel.offsetWidth; wheel.classList.add('spin');
    const j = await api('/api/roulette/spin', {method:'POST'});
    if (!j) return;
    document.getElementById('wheelMsg').textContent = j.message || '';
    document.getElementById('spinBtn').disabled = true;
    updateNextSpin(j.nextSpinAt);
    await load();
  }

  let wheelNextTimer;
  function updateNextSpin(iso){
    clearInterval(wheelNextTimer);
    const el = document.getElementById('wheelNext');
    if (!iso){ el.textContent = ''; return; }
    function tick(){
      const diff = new Date(iso) - new Date();
      if (diff <= 0){ el.textContent = ''; clearInterval(wheelNextTimer); return; }
      const h = Math.floor(diff/3600000);
      const m = Math.floor(diff%3600000/60000);
      const s = Math.floor(diff%60000/1000);
      el.textContent = `–°–ª–µ–¥—É—é—â–∞—è —Ä—É–ª–µ—Ç–∫–∞ —á–µ—Ä–µ–∑ ${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }
    tick();
    wheelNextTimer = setInterval(tick, 1000);
  }
  load();
</script>
<!-- –ò—Å—Ç–æ—Ä–∏—è: –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div id="histModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
  <div class="bg-slate-900 w-full max-w-3xl rounded-2xl shadow-xl p-4">
    <div class="flex items-center justify-between mb-3">
      <div class="flex items-center gap-2">
        <button class="btn" onclick="shiftMonth(-1)">‚Äπ</button>
        <div class="text-lg font-semibold"><span id="histMonthLabel"></span></div>
        <button class="btn" onclick="shiftMonth(1)">‚Ä∫</button>
      </div>
      <div class="flex items-center gap-2">
        <span class="pill bg-red-500/30"> <3 –±–∞–ª–ª–æ–≤ </span>
        <span class="pill bg-yellow-500/30"> 3‚Äì5 –±–∞–ª–ª–æ–≤ </span>
        <span class="pill bg-emerald-500/30"> >5 –±–∞–ª–ª–æ–≤ </span>
        <button class="btn" onclick="closeHistory()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>

    <div class="grid grid-cols-7 text-xs opacity-70 mb-2">
      <div>–ü–Ω</div><div>–í—Ç</div><div>–°—Ä</div><div>–ß—Ç</div><div>–ü—Ç</div><div>–°–±</div><div>–í—Å</div>
    </div>
    <div id="histGrid" class="grid grid-cols-7 gap-2"></div>

    <div id="histDayPanel" class="mt-4 hidden">
      <div class="text-sm font-semibold mb-2">–î–µ—Ç–∞–ª–∏: <span id="histDayLabel"></span></div>
      <div id="histDayList" class="space-y-1"></div>
    </div>
  </div>
</div>

<!-- –ü–æ–∫—É–ø–∫–∏: –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div id="purchModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
  <div class="bg-slate-900 w-full max-w-md rounded-2xl shadow-xl p-4">
    <div class="flex items-center justify-between mb-2">
      <div class="text-lg font-semibold">–ü–æ–∫—É–ø–∫–∏</div>
      <button class="btn" onclick="closePurchases()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div id="purchList" class="space-y-1 max-h-[60vh] overflow-y-auto"></div>
  </div>
</div>

<!-- –ü–æ–¥–∞—Ä–∫–∏: –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div id="giftsModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
  <div class="bg-slate-900 w-full max-w-md rounded-2xl shadow-xl p-4">
    <div class="flex items-center justify-between mb-2">
      <div class="text-lg font-semibold">–ü–æ–¥–∞—Ä–∫–∏</div>
      <button class="btn" onclick="closeGifts()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div id="giftsList" class="space-y-1 max-h-[60vh] overflow-y-auto"></div>
  </div>
</div>

</body>
</html>
