<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Админ — Бусёины</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
  <div class="max-w-5xl mx-auto p-4 space-y-6">
    <header class="flex items-center gap-4 mt-4">
      <h1 class="text-2xl font-bold">Админ-панель</h1>
      <div class="ml-auto text-xs opacity-70">Логин: admin / admin (Basic Auth)</div>
      <button class="btn" onclick="openHist()">История (правка)</button>
    </header>

    <section class="grid md:grid-cols-2 gap-6">
      <div class="bg-slate-900/70 p-4 rounded-2xl shadow">
        <h2 class="font-semibold mb-3">Магазин</h2>
        <textarea id="shopJson" class="w-full h-64 p-2 rounded bg-slate-800 font-mono text-xs"></textarea>
        <div class="mt-2 flex gap-2">
          <button class="btn" onclick="saveShop()">Сохранить</button>
          <span class="text-xs opacity-70">Массив объектов: {id,title,cost}</span>
        </div>
      </div>

      <div class="bg-slate-900/70 p-4 rounded-2xl shadow">
        <h2 class="font-semibold mb-3">Разовые цели</h2>
        <textarea id="goalsJson" class="w-full h-64 p-2 rounded bg-slate-800 font-mono text-xs"></textarea>
        <div class="mt-2 flex gap-2">
          <button class="btn" onclick="saveGoals()">Сохранить</button>
          <span class="text-xs opacity-70">Массив объектов: {id,title,reward,completedAt|null}</span>
        </div>
      </div>

      <div class="bg-slate-900/70 p-4 rounded-2xl shadow">
        <h2 class="font-semibold mb-3">Баланс</h2>
        <div class="text-sm mb-2">Текущий: <b id="admBalance">—</b></div>
        <div class="flex gap-2">
          <input id="admDelta" type="number" class="w-32 p-2 rounded bg-slate-800 border border-slate-700" placeholder="+/- сумма">
          <button class="btn" onclick="balanceAdd()">Добавить/Списать</button>
          <input id="admSet" type="number" class="w-32 p-2 rounded bg-slate-800 border border-slate-700" placeholder="новое значение">
          <button class="btn" onclick="balanceSet()">Установить</button>
        </div>
      </div>

      <div class="bg-slate-900/70 p-4 rounded-2xl shadow">
        <h2 class="font-semibold mb-3">Подарок</h2>
        <input id="giftTitle" type="text" class="w-full p-2 mb-2 rounded bg-slate-800 border border-slate-700" placeholder="Описание">
        <div class="flex gap-2 items-center">
          <input id="giftAmount" type="number" class="w-32 p-2 rounded bg-slate-800 border border-slate-700" placeholder="Бусёины">
          <button class="btn" onclick="addGift()">Добавить</button>
        </div>
      </div>

      <div class="bg-slate-900/70 p-4 rounded-2xl shadow md:col-span-2">
        <h2 class="font-semibold mb-3">Ежедневные задания (унифицированные)</h2>
        <textarea id="dailyJson" class="w-full h-64 p-2 rounded bg-slate-800 font-mono text-xs"></textarea>
        <div class="mt-2 flex gap-2">
          <button class="btn" onclick="saveDaily()">Сохранить</button>
          <span class="text-xs opacity-70">Массив объектов: {id,title,kind:MINUTES|CHECK,dailyReward,minutesPerDay?,weeklyMinutesGoal?,streakEnabled,weeklyRequiredCount}</span>
        </div>
      </div>
    </section>
  </div>
  <style>
    .btn { padding:.5rem .75rem; background: rgba(14,165,233,0.2); border:1px solid rgba(14,165,233,0.5); border-radius:.75rem; }
  </style>
  <script>
    let authHeader = 'Basic ' + btoa('user-admin:admin');
    async function api(url, body){
      const r = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json','Authorization':authHeader}, body: JSON.stringify(body)});
      if (!r.ok){ throw new Error(await r.text()); }
      return r.json();
    }
    async function load(){
      const me = await fetch('/api/me', {headers:{'Authorization':authHeader}}).then(r=>r.json());
      document.querySelector('#shopJson').value = JSON.stringify(me.shop, null, 2);
      document.querySelector('#goalsJson').value = JSON.stringify(me.goals, null, 2);
      document.querySelector('#dailyJson').value = JSON.stringify(me.tasks || [], null, 2);
    }
    async function saveShop(){ await api('/api/admin/shop', JSON.parse(document.querySelector('#shopJson').value)); alert('OK'); }
    async function saveGoals(){ await api('/api/admin/goals', JSON.parse(document.querySelector('#goalsJson').value)); alert('OK'); }
    async function saveDaily(){ await api('/api/admin/daily', JSON.parse(document.querySelector('#dailyJson').value)); alert('OK'); }

    async function addGift(){
      const title = document.getElementById('giftTitle').value.trim();
      const amount = parseInt(document.getElementById('giftAmount').value || '0', 10);
      if (!title || !Number.isFinite(amount) || amount <= 0) return;
      await api('/api/admin/gifts/add', {title, amount});
      document.getElementById('giftTitle').value = '';
      document.getElementById('giftAmount').value = '';
      alert('OK');
    }


    // ===== Баланс =====
    async function refreshBalance(){
      const me = await fetch('/api/me').then(r=>r.json());
      document.getElementById('admBalance').textContent = me.balance;
    }
    async function balanceAdd(){
      const v = parseInt(document.getElementById('admDelta').value || '0', 10);
      if (!Number.isFinite(v) || v === 0) return;
      const r = await fetch('/api/admin/balance/add?delta='+encodeURIComponent(v), {method:'POST'});
      const j = await r.json(); document.getElementById('admBalance').textContent = j.balance;
    }
    async function balanceSet(){
      const v = parseInt(document.getElementById('admSet').value || '0', 10);
      if (!Number.isFinite(v) || v < 0) return;
      const r = await fetch('/api/admin/balance/set?value='+encodeURIComponent(v), {method:'POST'});
      const j = await r.json(); document.getElementById('admBalance').textContent = j.balance;
    }

    // ===== История/правка =====
    let AY, AM, ADate;
    function openHist(){
      const now = new Date();
      AY = now.getFullYear(); AM = now.getMonth()+1;
      document.getElementById('admHist').classList.remove('hidden');
      document.getElementById('admHist').classList.add('flex');
      renderAdmMonth();
    }
    function closeHist(){
      document.getElementById('admHist').classList.add('hidden');
      document.getElementById('admHist').classList.remove('flex');
    }
    function monthLabel(y,m){ return new Date(Date.UTC(y,m-1,1)).toLocaleString('ru-RU',{month:'long',year:'numeric'}); }
    function shiftAdmMonth(delta){ AM += delta; if (AM<=0){AM=12;AY--} if (AM>=13){AM=1;AY++} renderAdmMonth(); }

    async function renderAdmMonth(){
      document.getElementById('admMonthLabel').textContent = monthLabel(AY, AM);
      const data = await fetch(`/api/admin/history/month?year=${AY}&month=${AM}`).then(r=>r.json());

      const grid = document.getElementById('admGrid'); grid.innerHTML='';
      const first = new Date(AY, AM-1, 1);
      let offset = (first.getDay()+6)%7;
      for (let i=0;i<offset;i++) grid.insertAdjacentHTML('beforeend','<div></div>');

      data.days.forEach(d=>{
        const dt = new Date(d.date), day = dt.getDate(), total = d.total||0;
        let cls='cal-cell'; if (total<3) cls+=' cal-red'; else if (total<=5) cls+=' cal-yellow'; else cls+=' cal-green';
        grid.insertAdjacentHTML('beforeend', `
        <div class="${cls}" onclick="openAdmDay('${d.date}')">
          <div class="date">${String(day).padStart(2,'0')}</div>
          <div class="sum">${total} бал.</div>
        </div>
      `);
      });

      document.getElementById('admDayPanel').classList.add('hidden');
    }

    async function openAdmDay(dateStr){
      ADate = dateStr;
      const d = await fetch(`/api/admin/history/day?date=${dateStr}`).then(r=>r.json());
      document.getElementById('admDayLabel').textContent =
              new Date(d.date).toLocaleDateString('ru-RU',{day:'2-digit',month:'long',year:'numeric'});

      // Подгрузим текущее состояние дня из /api/me (daily map) и generic def
      const me = await fetch('/api/me').then(r=>r.json());
      const log = (me && me.todayNutritionMinutes!==undefined) ? null : null; // не используется напрямую
      // Получим «сырой» daily из state не можем, поэтому восстановим эвристикой через /api/history/day + /api/me

      // Для формы:
      // - минуты берём из day.items суммами? Лучше просить пользователя ввести заново — мы установим точно.
      // Но удобнее подтянуть сохраненные минуты: добавим небольшой GET-хак на day raw? Если не хочешь менять API — просто оставляем поля пустыми.

      // Покажем чекбоксы по факту выполненности
      // Вычислим done-флаги из списка элементов (ищем по названиям)
      const has = (label) => (d.items||[]).some(it => it.label.startsWith(label));
      document.getElementById('admSport').checked = has('Спорт');
      document.getElementById('admYoga').checked  = has('Йога');
      document.getElementById('admViet').checked  = has('5 вьетнамских слов');

      // Минуты оставим пустыми — админ введет нужное (0..).
      document.getElementById('admNutriMin').value = '';
      document.getElementById('admEngMin').value   = '';

      // Generic список
      const box = document.getElementById('admGeneric'); box.innerHTML='';
      (me.genericDaily || []).forEach(def=>{
        const done = (d.items||[]).some(it => it.label.includes(def.title)); // грубо, но работает
        box.insertAdjacentHTML('beforeend', `
        <label class="flex items-center gap-2">
          <input type="checkbox" data-gid="${def.id}" ${done?'checked':''}> ${def.title} (+${def.dailyReward}${def.streakEnabled?' + стрик':''})
        </label>
      `);
      });

      // Покажем детализацию
      const list = document.getElementById('admDayItems'); list.innerHTML='';
      (d.items||[]).forEach(it=>{
        list.insertAdjacentHTML('beforeend', `
        <div class="p-2 rounded bg-slate-800/60 border border-slate-700/40 flex justify-between">
          <div class="text-sm">${it.label}</div>
          <div class="text-sm font-semibold">+${it.points}</div>
        </div>
      `);
      });
      document.getElementById('admDayTotal').textContent = d.total || 0;

      document.getElementById('admDayPanel').classList.remove('hidden');
    }

    async function saveAdmDay(){
      const nutri = document.getElementById('admNutriMin').value;
      const eng   = document.getElementById('admEngMin').value;
      const sport = document.getElementById('admSport').checked;
      const yoga  = document.getElementById('admYoga').checked;
      const viet  = document.getElementById('admViet').checked;
      const genIds = Array.from(document.querySelectorAll('#admGeneric input[type="checkbox"]'))
              .filter(x=>x.checked).map(x=>x.getAttribute('data-gid'));

      const body = {
        date: ADate,
        nutritionMinutes: nutri==='' ? null : parseInt(nutri,10),
        englishMinutes:   eng===''   ? null : parseInt(eng,10),
        sportDone: sport,
        yogaDone:  yoga,
        vietDone:  viet,
        genericDoneIds: genIds
      };

      const r = await fetch('/api/admin/day/upsert', {
        method:'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      const j = await r.json();

      // обновим карточки
      document.getElementById('admDayTotal').textContent = j.day.total;
      // перерисуем сетку месяца (там обновится цвет)
      await renderAdmMonth();
      await refreshBalance();
      // и снова раскроем текущий день (для свежей детализации)
      await openAdmDay(ADate);
    }

    // Инициализация при загрузке админки:
    (async function initAdmin(){
      await refreshBalance();
    })();
    load();
  </script>

  <!-- История (админ) -->
  <div id="admHist" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
    <div class="bg-slate-900 w-full max-w-4xl rounded-2xl shadow-xl p-4">
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-2">
          <button class="btn" onclick="shiftAdmMonth(-1)">‹</button>
          <div class="text-lg font-semibold"><span id="admMonthLabel"></span></div>
          <button class="btn" onclick="shiftAdmMonth(1)">›</button>
        </div>
        <div class="flex items-center gap-2">
          <span class="pill bg-red-500/30"> <3 баллов </span>
          <span class="pill bg-yellow-500/30"> 3–5 баллов </span>
          <span class="pill bg-emerald-500/30"> >5 баллов </span>
          <button class="btn" onclick="closeHist()">Закрыть</button>
        </div>
      </div>
      <div class="grid grid-cols-7 text-xs opacity-70 mb-2">
        <div>Пн</div><div>Вт</div><div>Ср</div><div>Чт</div><div>Пт</div><div>Сб</div><div>Вс</div>
      </div>
      <div id="admGrid" class="grid grid-cols-7 gap-2"></div>

      <!-- Панель редактирования дня -->
      <div id="admDayPanel" class="mt-4 hidden">
        <div class="text-sm font-semibold mb-2">Редактирование: <span id="admDayLabel"></span></div>
        <div class="grid md:grid-cols-3 gap-3">
          <div class="p-3 rounded-xl bg-slate-800/60 border border-slate-700/50">
            <div class="font-medium mb-2">Минутные</div>
            <label class="block text-sm mb-1">Нутрициология (мин)</label>
            <input id="admNutriMin" type="number" class="w-full p-2 rounded bg-slate-800 border border-slate-700" min="0">
            <label class="block text-sm mt-2 mb-1">Английский (мин)</label>
            <input id="admEngMin" type="number" class="w-full p-2 rounded bg-slate-800 border border-slate-700" min="0">
            <div class="text-xs opacity-70 mt-2">Награды за день будут выставлены автоматически по порогам (180/60).</div>
          </div>

          <div class="p-3 rounded-xl bg-slate-800/60 border border-slate-700/50">
            <div class="font-medium mb-2">Чек-задачи</div>
            <label class="flex items-center gap-2 text-sm"><input id="admSport" type="checkbox"> Спорт</label>
            <label class="flex items-center gap-2 text-sm"><input id="admYoga" type="checkbox"> Йога</label>
            <label class="flex items-center gap-2 text-sm"><input id="admViet" type="checkbox"> 5 вьетнамских слов</label>
          </div>

          <div class="p-3 rounded-xl bg-slate-800/60 border border-slate-700/50">
            <div class="font-medium mb-2">Generic (админские)</div>
            <div id="admGeneric" class="space-y-1 text-sm"></div>
          </div>
        </div>

        <div class="flex items-center justify-between mt-3">
          <div class="text-sm">Итого за день: <b id="admDayTotal">0</b></div>
          <button class="btn" onclick="saveAdmDay()">Сохранить и пересчитать</button>
        </div>

        <div class="mt-3" id="admDayItems" class="space-y-1"></div>
      </div>
    </div>
  </div>

</body>
</html>
